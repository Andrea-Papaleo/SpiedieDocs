<!DOCTYPE html>
 
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi-Core Processing (C++/OpenMP) | Spiedie | Binghamton University</title>
    <link rel="shortcut icon" href="http://localhost:4000/assets/images/favicon.ico" />

    <link rel="stylesheet" href="http://localhost:4000/assets/css/pygments.css" />
    <link rel="stylesheet" href="http://localhost:4000/assets/css/bingfont.css" />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.8.2/css/all.css"
      integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="http://localhost:4000/assets/css/default.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/default.min.css"> -->
    <!--<script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-11743206-2');
    </script>-->

  </head>
  <body>
    
    <div class="page-container">
      <nav class="navbar">
        <div class="navbar-container">
          <a class="navbar-brand" href="http://localhost:4000"
            ><i class="bu bu-b" style="font-size: 24px"></i>&nbsp;&nbsp; Spiedie
            Docs</a
          >
          <div class="navbar-toc-toggle">
            <button class="navbar-toc-toggle-button">
              <i class="fas fa-bars"></i>
            </button>
          </div>
          <ul class="navbar-menu">
            <li class="navbar-item">
              <a class="navbar-link" href="http://localhost:4000/docs">Docs</a>
            </li>
            <li class="navbar-item">
              <a class="navbar-link" href="http://localhost:4000/singularity"
                >Singularity</a
              >
            </li>
          </ul>
        </div>
        <div class="navbar-toc no-scroll-bar hidden" onclick="openNavbarToc();">
          

    <ol class="toc-l1"><li class="toc-item toc-l1-item">
        <h3 class="toc-l1-title">Introduction to Spiedie</h3>
        
            <ol class="sub-toc toc-l2"><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/introduction.html" >What ia a Cluster</a>
                    
                
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="https://www.binghamton.edu/watson/facilities/computing/high-performance.html" target="_blank">What is Spiedie</a>
                    
                
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="https://www.binghamton.edu/watson/facilities/computing/high-performance.html" target="_blank">How do I get an account</a>
                    
                
                
                    
                
                </li></ol>
        
        </li><li class="toc-item toc-l1-item">
        <h3 class="toc-l1-title">Getting Started</h3>
        
            <ol class="sub-toc toc-l2"><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/connect-to-spiedie.html" >Connecting to Spiedie</a>
                    
                
                
                    
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/home-directory.html" >User Home Directory</a>
                    
                
                
                    
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/data_transfer.html" >Transferring Data to the Cluster</a>
                    
                
                
                    
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/viewing-spiedie-resources.html" >Viewing Spiedie Resources</a>
                    
                
                
                    
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/submitting_jobs.html" >Running Jobs</a>
                    
                
                
                    
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/spiedie_modules.html" >Spiedie Modules</a>
                    
                
                
                    
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/compilers.html" >Compiling Code On Spiedie</a>
                    
                
                
                </li></ol>
        
        </li><li class="toc-item toc-l1-item">
        <h3 class="toc-l1-title">Tutorials</h3>
        
            <ol class="sub-toc toc-l2"><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/tutorials/python-environment.html" >Setting up a Python Environment</a>
                    
                
                
                    
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/tutorials/quick_start.html" >Quick Start (Python)</a>
                    
                
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/tutorials/spiedie_MPI.html" >MPI on Spiedie (C/MPI)</a>
                    
                
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/tutorials/spiedie_openmp_multi_core.html" >Multi-Core Processing (C++/OpenMP)</a>
                    
                
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/tutorials/spiedie_gpu_compute.html" >GPU on Spiedie (CUDA)</a>
                    
                
                
                </li></ol>
        
        </li><li class="toc-item toc-l1-item">
        <h3 class="toc-l1-title">Documentation</h3>
        
            <ol class="sub-toc toc-l2"><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/basic_linux_commands.html" >Basic Linux Commands</a>
                    
                
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/basic_slurm_commands.html" >Basic SLURM Commands</a>
                    
                
                
                    
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/spiedie_partitions.html" >Spiedie Partitions and Features</a>
                    
                
                
                    
                
                </li></ol>
        
        </li></ol>


        </div>
      </nav>

      <div class="content-container">
        <aside class="sidenav">
          <div class="sidenav-container">
            <div class="sidenav-search">
              <form class="search-bar">
                <input
                  type="text"
                  class="form-control docs_search"
                  placeholder="Search Docs"
                />
              </form>
            </div>
            <div class="sidenav-menu no-scroll-bar">
              

    <ol class="toc-l1"><li class="toc-item toc-l1-item">
        <h3 class="toc-l1-title">Introduction to Spiedie</h3>
        
            <ol class="sub-toc toc-l2"><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/introduction.html" >What ia a Cluster</a>
                    
                
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="https://www.binghamton.edu/watson/facilities/computing/high-performance.html" target="_blank">What is Spiedie</a>
                    
                
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="https://www.binghamton.edu/watson/facilities/computing/high-performance.html" target="_blank">How do I get an account</a>
                    
                
                
                    
                
                </li></ol>
        
        </li><li class="toc-item toc-l1-item">
        <h3 class="toc-l1-title">Getting Started</h3>
        
            <ol class="sub-toc toc-l2"><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/connect-to-spiedie.html" >Connecting to Spiedie</a>
                    
                
                
                    
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/home-directory.html" >User Home Directory</a>
                    
                
                
                    
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/data_transfer.html" >Transferring Data to the Cluster</a>
                    
                
                
                    
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/viewing-spiedie-resources.html" >Viewing Spiedie Resources</a>
                    
                
                
                    
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/submitting_jobs.html" >Running Jobs</a>
                    
                
                
                    
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/spiedie_modules.html" >Spiedie Modules</a>
                    
                
                
                    
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/compilers.html" >Compiling Code On Spiedie</a>
                    
                
                
                </li></ol>
        
        </li><li class="toc-item toc-l1-item">
        <h3 class="toc-l1-title">Tutorials</h3>
        
            <ol class="sub-toc toc-l2"><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/tutorials/python-environment.html" >Setting up a Python Environment</a>
                    
                
                
                    
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/tutorials/quick_start.html" >Quick Start (Python)</a>
                    
                
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/tutorials/spiedie_MPI.html" >MPI on Spiedie (C/MPI)</a>
                    
                
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/tutorials/spiedie_openmp_multi_core.html" >Multi-Core Processing (C++/OpenMP)</a>
                    
                
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/tutorials/spiedie_gpu_compute.html" >GPU on Spiedie (CUDA)</a>
                    
                
                
                </li></ol>
        
        </li><li class="toc-item toc-l1-item">
        <h3 class="toc-l1-title">Documentation</h3>
        
            <ol class="sub-toc toc-l2"><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/basic_linux_commands.html" >Basic Linux Commands</a>
                    
                
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/basic_slurm_commands.html" >Basic SLURM Commands</a>
                    
                
                
                    
                
                </li><li class=" toc-item toc-l2-item">
                    
                    
                        <a class="toc-link toc-l2-link" href="http://localhost:4000/docs/spiedie_partitions.html" >Spiedie Partitions and Features</a>
                    
                
                
                    
                
                </li></ol>
        
        </li></ol>


            </div>
          </div>
        </aside>
        <main>
          <section class="docs no-scroll-bar"><div class="docs-nav">
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
        <a id="prev-doc" href=/tutorials/spiedie_MPI.html><strong><<</strong> MPI on Spiedie (C/MPI)</a>
      
      
      
      
      
        <a id="next-doc" href=/tutorials/spiedie_gpu_compute.html>GPU on Spiedie (CUDA) <strong>>></strong></a>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      </div><h1>
               Multi-Core Processing (C++/OpenMP) 
            </h1>
            
            <article >
              <p>Things covered in this tutorial:</p>

<ol>
  <li><a href="#sbatch_omp">Writing batch scripts for multi-core programs</a></li>
  <li><a href="../docs/spiedie_partitions.html">Suitable Partitions for job requirements</a></li>
  <li><a href="../docs/spiedie_modules.html">Compiling and linking on the fly</a></li>
</ol>

<p>We assume you have familiarity with the OpenMP interface.</p>

<p><a href="http://www.openmp.org" target="_blank"> Click here if you would like to learn more</a></p>

<h2 id="-getting-started-with-openmp"><a name="getting_started"></a> Getting Started with OpenMP</h2>

<p>We are going to run a multi-core program which will utilize shared memory parallelism in a single node for high performance computing.</p>

<p><strong><em>Note: If you would like to utilize parallelization using multiple nodes, checkout the MPI tutorial <a href="spiedie_MPI.html">here</a></em></strong></p>

<p>We’ve provided a simple openMP program source code <a href="code/open_mp.c" download=""> here</a>.</p>

<h3 id="-set-up-the-environment"><a name="environment_setup"></a> Set up the Environment</h3>

<p>Similar to the previous tutorials, lets create a new directory called <em>openMP-tutorial</em>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>openMP-tutorial
</code></pre></div></div>

<p>Now exit out of spiedie or open a new terminal window on your local machine. If you haven’t downloaded the <em>open_mp.c</em> file yet, do so now. Once you have the <em>open_mp.c</em> file, secure copy it to your new folder in spiedie.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp path/to/open_mp.c &lt;username&gt;@spiedie.binghamton.edu:openMP-tutorial
</code></pre></div></div>

<p>Back in your spiedie terminal you can verify you have the file in the right place by changing into to <em>openMP-tutorial</em> directory and using <code class="language-plaintext highlighter-rouge">ls</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>spiedie81 ~]<span class="nv">$ </span><span class="nb">cd </span>openMP-tutorial/
<span class="o">[</span>spiedie81 openMP-tutorial]<span class="nv">$ </span><span class="nb">ls
</span>open_mp.c
</code></pre></div></div>
<p>open_mp.c:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;omp.h&gt;
</span> 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="cp">#pragma omp parallel
</span>  <span class="p">{</span>
    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">omp_get_thread_num</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="n">omp_get_num_threads</span><span class="p">();</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Greetings from process %d out of %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">total</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"parallel for ends.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The simple program prints out a message for each active thread.</p>

<h2 id="-creating-the-run-script-for-openmp"><a name="openmp_sbatch"></a> Creating the Run Script for OpenMP</h2>

<p>Let’s write a run script <em>omp_run.sh</em> to run our program using a text editor, for this tutorial we use <strong>emacs</strong>.</p>

<p>First of all, we will include the shebang, as usual,</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
</code></pre></div></div>
<h4 id="resource-allocation">Resource Allocation</h4>

<p>Next we will give our job a name:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#SBATCH --job-name=OMP_TEST</span>
</code></pre></div></div>

<p>Also, we can assign our output file name:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#SBATCH --job-name=OMP_TEST</span>
<span class="c">#SBATCH --output=omp_output.log</span>
</code></pre></div></div>

<p>Since we are using OpenMP and shared memory parallelism, we will only be using a single compute node:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#SBATCH --job-name=OMP_TEST</span>
<span class="c">#SBATCH --output=omp_output.log</span>
<span class="c"># Number of processors</span>
<span class="c">#SBATCH -N 1</span>
</code></pre></div></div>

<p>We will set the number of cores to 4 with:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#SBATCH --job-name=OMP_TEST</span>
<span class="c">#SBATCH --output=omp_output.log</span>
<span class="c"># Number of processors</span>
<span class="c">#SBATCH -N 1</span>
<span class="c"># Number of cores</span>
<span class="c">#SBATCH -c 4</span>
</code></pre></div></div>

<p>Depending on the number of cores being used, it is a good idea to consider with partition would be the suitable for our program. The details for the partitions and the number of cores available per compute node can be found <a href="../docs/spiedie_partitions.html">here</a></p>

<p>If you are using more thant 20 cores, it is recommended to assign the partition to KNL nodes.</p>

<p>In our test, we will use the standard partition due to our relatively small number of cores.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#SBATCH --job-name=OMP_TEST</span>
<span class="c">#SBATCH --output=omp_output.log</span>
<span class="c"># Number of processors</span>
<span class="c">#SBATCH -N 1</span>
<span class="c"># Number of cores</span>
<span class="c">#SBATCH -c 4</span>
<span class="c">#SBATCH --partition=Standard</span>
</code></pre></div></div>

<p>We are now going to dynamically assign the number of OpenMP threads the program utilizes depending on the -c parameter we used above.</p>

<p>We’ll add a line which sets the OMP_NUM_THREADS to the same values as -c:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#SBATCH --job-name=OMP_TEST</span>
<span class="c">#SBATCH --output=omp_output.log</span>
<span class="c"># Number of processors</span>
<span class="c">#SBATCH -N 1</span>
<span class="c"># Number of cores</span>
<span class="c">#SBATCH --c 4</span>
<span class="c">#SBATCH --partition=Standard</span>

<span class="c"># Set OMP_NUM_THREADS to the same value as -c</span>
<span class="c"># with a fallback in case it isn't set.</span>
<span class="c"># SLURM_CPUS_PER_TASK is set to the value of -c, but only if -c is explicitly set</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$SLURM_CPUS_PER_TASK</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">omp_threads</span><span class="o">=</span><span class="nv">$SLURM_CPUS_PER_TASK</span>
</code></pre></div></div>

<p>In case the -c is not set, we fall back to 1 core (as is the default):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#SBATCH --job-name=OMP_TEST</span>
<span class="c">#SBATCH --output=omp_output.log</span>
<span class="c"># Number of processors</span>
<span class="c">#SBATCH -N 1</span>
<span class="c"># Number of cores</span>
<span class="c">#SBATCH -c 4</span>
<span class="c">#SBATCH --partition=Standard</span>

<span class="c"># Set OMP_NUM_THREADS to the same value as -c</span>
<span class="c"># with a fallback in case it isn't set.</span>
<span class="c"># SLURM_CPUS_PER_TASK is set to the value of -c, but only if -c is explicitly set</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$SLURM_CPUS_PER_TASK</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">omp_threads</span><span class="o">=</span><span class="nv">$SLURM_CPUS_PER_TASK</span>
<span class="k">else
  </span><span class="nv">omp_threads</span><span class="o">=</span>1
<span class="k">fi</span>
</code></pre></div></div>

<p>Export the value to complete the process:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#SBATCH --job-name=OMP_TEST</span>
<span class="c">#SBATCH --output=omp_output.log</span>
<span class="c"># Number of processors</span>
<span class="c">#SBATCH -N 1</span>
<span class="c"># Number of cores</span>
<span class="c">#SBATCH -c 4</span>
<span class="c">#SBATCH --partition=Standard</span>

<span class="c"># Set OMP_NUM_THREADS to the same value as -c</span>
<span class="c"># with a fallback in case it isn't set.</span>
<span class="c"># SLURM_CPUS_PER_TASK is set to the value of -c, but only if -c is explicitly set</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$SLURM_CPUS_PER_TASK</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">omp_threads</span><span class="o">=</span><span class="nv">$SLURM_CPUS_PER_TASK</span>
<span class="k">else
  </span><span class="nv">omp_threads</span><span class="o">=</span>1
<span class="k">fi

</span><span class="nb">export </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="nv">$omp_threads</span>
</code></pre></div></div>
<h4 id="loading-the-modules">Loading the Modules</h4>

<p>It is good practice to clear the environment from any previously loaded modules</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#SBATCH --job-name=OMP_TEST</span>
<span class="c">#SBATCH --output=omp_output.log</span>
<span class="c"># Number of processors</span>
<span class="c">#SBATCH -N 1</span>
<span class="c"># Number of cores</span>
<span class="c">#SBATCH -c 4</span>
<span class="c">#SBATCH --partition=Standard</span>

<span class="c"># Set OMP_NUM_THREADS to the same value as -c</span>
<span class="c"># with a fallback in case it isn't set.</span>
<span class="c"># SLURM_CPUS_PER_TASK is set to the value of -c, but only if -c is explicitly set</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$SLURM_CPUS_PER_TASK</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">omp_threads</span><span class="o">=</span><span class="nv">$SLURM_CPUS_PER_TASK</span>
<span class="k">else
  </span><span class="nv">omp_threads</span><span class="o">=</span>1
<span class="k">fi

</span><span class="nb">export </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="nv">$omp_threads</span>

<span class="c"># Clear the environment from any previously loaded modules</span>
module purge <span class="o">&gt;</span> /dev/null 2&gt;&amp;1

</code></pre></div></div>

<p>It is also good practice to compile and link custom code during your run, in order to make sure the programs run correctly.</p>

<p>So we can load the gcc module:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#SBATCH --job-name=OMP_TEST</span>
<span class="c">#SBATCH --output=omp_output.log</span>
<span class="c"># Number of processors</span>
<span class="c">#SBATCH -N 1</span>
<span class="c"># Number of cores</span>
<span class="c">#SBATCH -c 4</span>
<span class="c">#SBATCH --partition=Standard</span>

<span class="c"># Set OMP_NUM_THREADS to the same value as -c</span>
<span class="c"># with a fallback in case it isn't set.</span>
<span class="c"># SLURM_CPUS_PER_TASK is set to the value of -c, but only if -c is explicitly set</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$SLURM_CPUS_PER_TASK</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">omp_threads</span><span class="o">=</span><span class="nv">$SLURM_CPUS_PER_TASK</span>
<span class="k">else
  </span><span class="nv">omp_threads</span><span class="o">=</span>1
<span class="k">fi

</span><span class="nb">export </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="nv">$omp_threads</span>

<span class="c"># Clear the environment from any previously loaded modules</span>
module purge <span class="o">&gt;</span> /dev/null 2&gt;&amp;1

module load gcc
</code></pre></div></div>

<p>We can call the compiler as usual:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#SBATCH --job-name=OMP_TEST</span>
<span class="c">#SBATCH --output=omp_output.log</span>
<span class="c"># Number of processors</span>
<span class="c">#SBATCH -N 1</span>
<span class="c"># Number of cores</span>
<span class="c">#SBATCH -c 4</span>
<span class="c">#SBATCH --partition=Standard</span>

<span class="c"># Set OMP_NUM_THREADS to the same value as -c</span>
<span class="c"># with a fallback in case it isn't set.</span>
<span class="c"># SLURM_CPUS_PER_TASK is set to the value of -c, but only if -c is explicitly set</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$SLURM_CPUS_PER_TASK</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">omp_threads</span><span class="o">=</span><span class="nv">$SLURM_CPUS_PER_TASK</span>
<span class="k">else
  </span><span class="nv">omp_threads</span><span class="o">=</span>1
<span class="k">fi

</span><span class="nb">export </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="nv">$omp_threads</span>

<span class="c"># Clear the environment from any previously loaded modules</span>
module purge <span class="o">&gt;</span> /dev/null 2&gt;&amp;1

module load gcc

gcc <span class="nt">-o</span> spiedie_omp open_mp.c <span class="nt">-fopenmp</span>
</code></pre></div></div>

<p>and finally, we can instruct the script to run the program:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#SBATCH --job-name=OMP_TEST</span>
<span class="c">#SBATCH --output=omp_output.log</span>
<span class="c"># Number of processors</span>
<span class="c">#SBATCH -N 1</span>
<span class="c"># Number of cores</span>
<span class="c">#SBATCH -c 4</span>
<span class="c">#SBATCH --partition=Standard</span>

<span class="c"># Set OMP_NUM_THREADS to the same value as -c</span>
<span class="c"># with a fallback in case it isn't set.</span>
<span class="c"># SLURM_CPUS_PER_TASK is set to the value of -c, but only if -c is explicitly set</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$SLURM_CPUS_PER_TASK</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">omp_threads</span><span class="o">=</span><span class="nv">$SLURM_CPUS_PER_TASK</span>
<span class="k">else
  </span><span class="nv">omp_threads</span><span class="o">=</span>1
<span class="k">fi

</span><span class="nb">export </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="nv">$omp_threads</span>

<span class="c"># Clear the environment from any previously loaded modules</span>
module purge <span class="o">&gt;</span> /dev/null 2&gt;&amp;1

module load gcc

gcc <span class="nt">-o</span> spiedie_omp open_mp.c <span class="nt">-fopenmp</span>

./spiedie_omp
</code></pre></div></div>
<p>The final run script can be downloaded <a href="code/omp_run.sh" download=""> here</a></p>

<h2 id="-submitting-the-run-script-for-openmpi"><a name="mpi_submit"></a> Submitting the Run Script for OpenMPI</h2>

<p>We can submit our script by simply using:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sbatch omp_run.sh
</code></pre></div></div>
<p>The job should run pretty quickly, but since we are running on the Standard compute nodes the time may vary depending on their current load.</p>

<p>You can monitor the job status but running</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>squeue | <span class="nb">grep </span>username
</code></pre></div></div>
<p>replacing <em>username</em> with your username.</p>

<p>Once the job is complete you can view the output by using <code class="language-plaintext highlighter-rouge">cat</code>. You should expect to see an output like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>spiedie81 openMP-tutorial]<span class="nv">$ </span><span class="nb">cat </span>omp_output.log 
Greetings from process 1 out of 4 
Greetings from process 0 out of 4 
Greetings from process 3 out of 4 
Greetings from process 2 out of 4 
parallel <span class="k">for </span>ends.
</code></pre></div></div>

<p>We can also change the number of cores being assigned by using:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sbatch <span class="nt">-c</span> 2 omp_run.sh
</code></pre></div></div>
<p>The output for this should be:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>spiedie81 openMP-tutorial]<span class="nv">$ </span><span class="nb">cat </span>omp_output.log 
Greetings from process 0 out of 2 
Greetings from process 1 out of 2 
parallel <span class="k">for </span>ends.
</code></pre></div></div>

<p>Congratulations, you’ve run your first openMP script!</p>


            </article><div class="docs-nav">
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
        <a id="prev-doc" href=/tutorials/spiedie_MPI.html><strong><<</strong> MPI on Spiedie (C/MPI)</a>
      
      
      
      
      
        <a id="next-doc" href=/tutorials/spiedie_gpu_compute.html>GPU on Spiedie (CUDA) <strong>>></strong></a>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      </div></section>
        </main>
        <aside class="content-detail">
          <!-- Begin Tags -->
          <div class="content-tags-container">
    <h3 class="content-tags-title">Tags</h3>
    <ul class="content-tags-list">
    
        <li class="content-tag">
        <a class="content-tag-link" href="http://localhost:4000/tags#tutorial">
            tutorial
        </a>
        </li>
    
        <li class="content-tag">
        <a class="content-tag-link" href="http://localhost:4000/tags#multicore">
            multicore
        </a>
        </li>
    
    </ul>
</div>
          <!-- End Tags -->
        </aside>  
      </div>
      <footer class="row">
        <script src="http://localhost:4000/assets/js/sidenavToggle.js"></script>
        <div class="col-sm-12">
          <!-- Footer -->
        </div>
      </footer>
    </div>
    <script
      src="https://code.jquery.com/jquery-2.2.4.min.js"
      integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <script src="http://localhost:4000/assets/js/jquery.autocomplete.js"></script>
    <!-- <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script> -->
    <script>
      var docs_arr = [
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          {
            "url":`/tutorials/`,
            "value": `Tutorials` 
          },
        
      
        
      
        
      
        
      
        
          {
            "url":`/tutorials/python-environment.html`,
            "value": `Setting Up a Python Environment` 
          },
        
      
        
          {
            "url":`/tutorials/quick_start.html`,
            "value": `Quick Start Tutorial - Python` 
          },
        
      
        
      
        
      
        
          {
            "url":`/tutorials/spiedie_MPI.html`,
            "value": `MPI on Spiedie (C/MPI)` 
          },
        
      
        
          {
            "url":`/tutorials/spiedie_conda.html`,
            "value": `Conda on Spiedie (intermediate)` 
          },
        
      
        
      
        
          {
            "url":`/tutorials/spiedie_gpu_compute.html`,
            "value": `GPU on Spiedie (CUDA)` 
          },
        
      
        
      
        
      
        
          {
            "url":`/tutorials/spiedie_multiprocessing.html`,
            "value": `Python Multi-Core Tutorial` 
          },
        
      
        
          {
            "url":`/tutorials/spiedie_openmp_multi_core.html`,
            "value": `Multi-Core Processing (C++/OpenMP)` 
          },
        
      
        
      
        
          {
            "url":`/tutorials/spiedie_singularity.html`,
            "value": `Singularity Containers on Spiedie (advanced)` 
          },
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
      
        {
          "url":`/tags#blas`,
          "value":`BLAS`
        },
      
        {
          "url":`/tags#clang`,
          "value":`CLANG`
        },
      
        {
          "url":`/tags#cmake`,
          "value":`CMAKE`
        },
      
        {
          "url":`/tags#cublas`,
          "value":`CUBLAS`
        },
      
        {
          "url":`/tags#cuda`,
          "value":`CUDA`
        },
      
        {
          "url":`/tags#check-job-status`,
          "value":`Check Job Status`
        },
      
        {
          "url":`/tags#cloud-storage`,
          "value":`Cloud Storage`
        },
      
        {
          "url":`/tags#conda`,
          "value":`Conda`
        },
      
        {
          "url":`/tags#configuration`,
          "value":`Configuration`
        },
      
        {
          "url":`/tags#containers`,
          "value":`Containers`
        },
      
        {
          "url":`/tags#create-images`,
          "value":`Create Images`
        },
      
        {
          "url":`/tags#faq`,
          "value":`FAQ`
        },
      
        {
          "url":`/tags#file-transfer`,
          "value":`File Transfer`
        },
      
        {
          "url":`/tags#forwarding`,
          "value":`Forwarding`
        },
      
        {
          "url":`/tags#gcc`,
          "value":`GCC`
        },
      
        {
          "url":`/tags#gemm`,
          "value":`GEMM`
        },
      
        {
          "url":`/tags#gpu`,
          "value":`GPU`
        },
      
        {
          "url":`/tags#gpucompute`,
          "value":`GPUCompute`
        },
      
        {
          "url":`/tags#gui`,
          "value":`GUI`
        },
      
        {
          "url":`/tags#icc`,
          "value":`ICC`
        },
      
        {
          "url":`/tags#intel-compilers`,
          "value":`Intel Compilers`
        },
      
        {
          "url":`/tags#interactive-sessions`,
          "value":`Interactive Sessions`
        },
      
        {
          "url":`/tags#job-submission`,
          "value":`Job Submission`
        },
      
        {
          "url":`/tags#linux`,
          "value":`Linux`
        },
      
        {
          "url":`/tags#login`,
          "value":`Login`
        },
      
        {
          "url":`/tags#matlab`,
          "value":`MATLAB`
        },
      
        {
          "url":`/tags#mvapich2`,
          "value":`MVAPICH2`
        },
      
        {
          "url":`/tags#mac`,
          "value":`Mac`
        },
      
        {
          "url":`/tags#modules`,
          "value":`Modules`
        },
      
        {
          "url":`/tags#multiprocessing`,
          "value":`Multiprocessing`
        },
      
        {
          "url":`/tags#new-user`,
          "value":`New_User`
        },
      
        {
          "url":`/tags#python`,
          "value":`Python`
        },
      
        {
          "url":`/tags#python-program`,
          "value":`Python Program`
        },
      
        {
          "url":`/tags#remote-access`,
          "value":`Remote Access`
        },
      
        {
          "url":`/tags#remote-build`,
          "value":`Remote Build`
        },
      
        {
          "url":`/tags#run-program`,
          "value":`Run Program`
        },
      
        {
          "url":`/tags#sbatch`,
          "value":`SBATCH`
        },
      
        {
          "url":`/tags#slurm`,
          "value":`SLURM`
        },
      
        {
          "url":`/tags#srun`,
          "value":`SRUN`
        },
      
        {
          "url":`/tags#setup`,
          "value":`Setup`
        },
      
        {
          "url":`/tags#singularity`,
          "value":`Singularity`
        },
      
        {
          "url":`/tags#submit-job`,
          "value":`Submit Job`
        },
      
        {
          "url":`/tags#submit-job`,
          "value":`Submit job`
        },
      
        {
          "url":`/tags#sylabs-cloud-services`,
          "value":`Sylabs Cloud Services`
        },
      
        {
          "url":`/tags#tensorflow`,
          "value":`Tensorflow`
        },
      
        {
          "url":`/tags#tensorflow-gpu`,
          "value":`Tensorflow-GPU`
        },
      
        {
          "url":`/tags#tutorial`,
          "value":`Tutorial`
        },
      
        {
          "url":`/tags#virtualenv`,
          "value":`VirtualEnv`
        },
      
        {
          "url":`/tags#windows`,
          "value":`Windows`
        },
      
        {
          "url":`/tags#workflow`,
          "value":`Workflow`
        },
      
        {
          "url":`/tags#x11`,
          "value":`X11`
        },
      
        {
          "url":`/tags#containers`,
          "value":`containers`
        },
      
        {
          "url":`/tags#create-image`,
          "value":`create image`
        },
      
        {
          "url":`/tags#custom-container`,
          "value":`custom container`
        },
      
        {
          "url":`/tags#docs`,
          "value":`docs`
        },
      
        {
          "url":`/tags#features`,
          "value":`features`
        },
      
        {
          "url":`/tags#interactive-session`,
          "value":`interactive session`
        },
      
        {
          "url":`/tags#memory-allocation`,
          "value":`memory allocation`
        },
      
        {
          "url":`/tags#memory-management`,
          "value":`memory management`
        },
      
        {
          "url":`/tags#modules`,
          "value":`modules`
        },
      
        {
          "url":`/tags#mpi`,
          "value":`mpi`
        },
      
        {
          "url":`/tags#multicore`,
          "value":`multicore`
        },
      
        {
          "url":`/tags#multinode`,
          "value":`multinode`
        },
      
        {
          "url":`/tags#partitions`,
          "value":`partitions`
        },
      
        {
          "url":`/tags#sacct`,
          "value":`sacct`
        },
      
        {
          "url":`/tags#sbatch`,
          "value":`sbatch`
        },
      
        {
          "url":`/tags#sinfo`,
          "value":`sinfo`
        },
      
        {
          "url":`/tags#singularity`,
          "value":`singularity`
        },
      
        {
          "url":`/tags#singularity-definition-files`,
          "value":`singularity definition files`
        },
      
        {
          "url":`/tags#singularity-exec`,
          "value":`singularity exec`
        },
      
        {
          "url":`/tags#singularity-recipes`,
          "value":`singularity recipes`
        },
      
        {
          "url":`/tags#singularity-run`,
          "value":`singularity run`
        },
      
        {
          "url":`/tags#srun`,
          "value":`srun`
        },
      
        {
          "url":`/tags#tutorial`,
          "value":`tutorial`
        },
      
        {
          "url":`/tags#tutorials`,
          "value":`tutorials`
        },
      
        {
          "url":`/tags#virtual-environment`,
          "value":`virtual environment`
        },
      
        {
          "url":`/tags#x2go`,
          "value":`x2go`
        },
      
      ];
      $('.docs_search').autocomplete({
          lookup: docs_arr,
          onSelect: function (suggestion) {
              window.location = "http://localhost:4000"+suggestion.url
          }
      });
    </script>
  </body>
</html>
